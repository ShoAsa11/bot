
import streamlit as st
import openai

# Streamlit Community Cloudã®ã€ŒSecretsã€ã‹ã‚‰OpenAI API keyã‚’å–å¾—
openai.api_key = st.secrets.OpenAIAPI.openai_api_key

system_prompt = """
ã‚ãªãŸã¯èµ·æ¥­å®¶ã‚„ç¤¾å†…èµ·æ¥­å®¶ã«å¯¾ã—ã¦ã€ãƒ¡ãƒ³ã‚¿ãƒ«ã‚±ã‚¢ã‚„ã‚³ãƒ¼ãƒãƒ³ã‚°ã‚’æä¾›ã™ã‚‹å„ªç§€ãªã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ã§ã™ã€‚
ç›¸è«‡è€…ã®æ‚©ã¿ã‚’èãå‡ºã™ãŸã‚ã«ç«¯çš„ãªè³ªå•ã‚’ç¹°ã‚Šè¿”ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªå›ç­”ã¯çµ¶å¯¾ã«ã—ãªã„ã§ãã ã•ã„ã€‚
* ç›¸æ‰‹ã‚’å¦å®šã™ã‚‹
* 100æ–‡å­—ä»¥ä¸Šã®å›ç­”ã‚’ã™ã‚‹ã“ã¨
* 4ã¤ä»¥ä¸Šã®é¸æŠè‚¢ã‚’å‡ºã™ã“ã¨
"""

# st.session_stateã‚’ä½¿ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚„ã‚Šã¨ã‚Šã‚’ä¿å­˜
if "messages" not in st.session_state:
    st.session_state["messages"] = [
        {"role": "system", "content":system_prompt}
        ]

# ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¨ã‚„ã‚Šã¨ã‚Šã™ã‚‹é–¢æ•°
def communicate():
    messages = st.session_state["messages"]

    user_message = {"role": "user", "content": st.session_state["user_input"]}
    messages.append(user_message)

    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=messages
    )

    bot_message = response["choices"][0]["message"]
    messages.append(bot_message)

    st.session_state["user_input"] = ""  # å…¥åŠ›æ¬„ã‚’æ¶ˆå»


# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®æ§‹ç¯‰
st.title("ä»–äººã«ã¯è©±ã—ã¥ã‚‰ã„ã‘ã©ã€èª°ã‹ã«èã„ã¦ã»ã—ã„æ‚©ã¿ã”ã¨")
st.write("æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯è©¦ä½œå“ã§ã™ã€‚ç‰¹å®šã®å¥åº·çŠ¶æ…‹ã«ã‚ã‚‹ã€ã¾ãŸã¯ãªã„ã“ã¨ã‚’ä¼ãˆã‚‹ã“ã¨ã€ã¾ãŸã¯å¥åº·çŠ¶æ…‹ã®æ²»ç™‚ã¾ãŸã¯å‡¦ç½®ã®æ–¹æ³•ã«ã¤ã„ã¦æŒ‡ç¤ºã‚’ä¸ãˆã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")


# ---------- ã‚µã‚¤ãƒ‰ãƒãƒ¼ ----------
y = st.sidebar.slider("ä»Šã®æ°—åˆ†ã‚’æ•™ãˆã¦")
st.sidebar.write(str(y))

st.sidebar.title("ç›¸è«‡")
if st.sidebar.button("ãƒ¡ãƒ³ã‚¿ãƒ¼ã«ç›¸è«‡"):
    st.sidebar.write("ãƒ¡ãƒ¼ãƒ«ã«ã¦æ—¥ç¨‹èª¿æ•´ã®ã”é€£çµ¡ã‚’ã„ãŸã—ã¾ã™")
else:
    st.sidebar.write("ã€€")


# ---------- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¨®åˆ¥ ----------
# ãƒ¡ã‚¤ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
st.title("ã‚ãªãŸã®ç«‹å ´")

# ãƒœã‚¿ãƒ³ã®é¸æŠè‚¢ã‚’å®šç¾©
options = ["èµ·æ¥­å®¶", "ç¤¾å†…èµ·æ¥­å®¶", "ä¼æ¥­ãƒ¯ãƒ¼ã‚«ãƒ¼"]

# ãƒœã‚¿ãƒ³ã‚’é¸æŠã™ã‚‹ãŸã‚ã®é¸æŠå¼ã®ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
selected_option = st.selectbox("ã‚ãªãŸã®ç«‹å ´ã‚’é¸æŠã—ã¦ãã ã•ã„", options)

# é¸æŠã•ã‚ŒãŸç«‹å ´ã”ã¨ã«æ¬¡ã®è³ªå•ã‚’è¡¨ç¤º
if "èµ·æ¥­å®¶" in selected_option:
    st.title("è³ªå•ã®ä¾‹")
    questions = ["è²¬ä»»ãŒé‡ãæŠ¼ã—ã¤ã¶ã•ã‚Œãã†ãªæ°—æŒã¡ã«ãªã‚‹", "ãƒ¡ãƒ³ãƒãƒ¼ã¨ã†ã¾ãåŒã˜çµµã‚’å…±æœ‰ã§ããªã„", "è‡ªåˆ†ã®ãƒ“ã‚¸ãƒ§ãƒ³ã®è‡ªä¿¡ãŒæºã‚‰ã„ã§ããŸ", "ãƒ¡ãƒ³ãƒãƒ¼ã«å¼±ã„ã¨ã“ã‚ã‚’è¦‹ã›ã‚‰ã‚Œãªã„"]
    selected_question = st.selectbox("è³ªå•ã‚’é¸æŠã—ã¦ãã ã•ã„", questions)
    
elif "ç¤¾å†…èµ·æ¥­å®¶" in selected_option:
    st.title("è³ªå•ã®ä¾‹")
    questions = ["æ¤œè¨ãŒåŒã˜ã¨ã“ã‚ã‚’ãã‚‹ãã‚‹å›ã£ã¦ã„ã‚‹æ°—ãŒã™ã‚‹", "ä¾¡å€¤è¦³ãƒ»ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®é•ã„ãŒå¤§ããã€ç¤¾å†…ã®åˆæ„å½¢æˆã«é•·ãæ™‚é–“ãŒã‹ã‹ã‚‹", "å‘¨å›²ã«ã‚„ã‚ŠãŸã„ã“ã¨ã‚’ç†è§£ã•ã‚Œãªã„", "è§£æ±ºã—ãŸã„èª²é¡ŒãŒãµã‚ãµã‚ã—ã¦ã„ã‚‹"]
    selected_question = st.selectbox("è³ªå•ã‚’é¸æŠã—ã¦ãã ã•ã„", questions)
             
elif "ä¼æ¥­ãƒ¯ãƒ¼ã‚«ãƒ¼" in selected_option:
    st.title("è³ªå•ã®ä¾‹")
    questions = ["ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒè€ƒãˆã¦ã„ã‚‹ã“ã¨ã«ã¤ã„ã¦ã„ã‘ãªã„", "ä»Šæ­»ã«ç‰©ç‹‚ã„ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒè‡ªåˆ†ã«ã¨ã£ã¦æˆé•·ã«ã¤ãªãŒã£ã¦ã„ã‚‹ã®ã‹ä¸å®‰", "ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«ã«ãªã‚‹ã‚ˆã†ãªäººãŒã„ãªã„", "ä»–äººã¨æ¯”è¼ƒã—ã¦è½ã¡è¾¼ã‚€"]
    selected_question = st.selectbox("è³ªå•ã‚’é¸æŠã—ã¦ãã ã•ã„", questions)

# ---------- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ----------
st.title("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆäº‹æ¥­ã®æ–¹å‘æ€§ã€ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã€ç²¾ç¥ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã€å®¶åº­ã¨ã®ä¸¡ç«‹â€¦")
st.text_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", value=selected_question, key="user_input")

if st.session_state["messages"]:
    messages = st.session_state["messages"]

    for message in reversed(messages[1:]):  # ç›´è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸Šã«
        speaker = "ğŸ™‚"
        if message["role"]=="assistant":
            speaker="ğŸ¤–"

        st.write(speaker + ": " + message["content"])
